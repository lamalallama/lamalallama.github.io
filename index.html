<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EL CHAT</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #222;
        color: #fff;
        text-align: center;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 600px;
        margin: auto;
        padding: 20px;
      }
      .button {
        display: inline-block;
        padding: 10px 20px;
        background-color: #4caf50;
        color: #fff;
        text-decoration: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        margin: 10px;
        border-radius: 5px;
        transition: background-color 0.3s ease;
      }
      .button:hover {
        background-color: #45a049;
      }
      .chat-code {
        font-size: 20px;
        background-color: #333;
        color: #fff;
        padding: 10px;
        border-radius: 5px;
        margin: 20px 0;
      }
      .chat-screen {
        background-color: #333;
        padding: 20px;
        min-height: 300px;
        border-radius: 10px;
        margin-top: 20px;
        text-align: left;
        overflow-y: scroll;
        max-height: 400px;
      }
      .message {
        background-color: #444;
        color: #fff;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
      }
      .input-box {
        width: calc(100% - 20px);
        padding: 10px;
        margin: 10px 0;
        background-color: #444;
        border: none;
        color: #fff;
        border-radius: 5px;
        font-size: 16px;
      }
      .arrow-back {
        position: absolute;
        top: 10px;
        left: 10px;
        cursor: pointer;
      }
      .download-button {
        display: inline-block;
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        text-decoration: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        margin: 10px;
        border-radius: 5px;
        transition: background-color 0.3s ease;
      }
      .download-button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>EL CHAT</h1>
      <div id="main-menu">
        <a href="#" class="button" onclick="createChat()">Crear Chat</a>
        <a href="#" class="button" onclick="joinChat()">Unirse a Chat</a>
      </div>

      <!-- Create Chat Screen -->
      <div id="create-chat" style="display: none">
        <a href="#" class="arrow-back" onclick="backToMainMenu()"
          >&larr; Back</a
        >
        <h2>Create Chat</h2>
        <div class="chat-code" id="chat-code-display"></div>
        <div class="chat-screen" id="chat-screen"></div>
        <input
          type="text"
          id="message-input"
          class="input-box"
          placeholder="Type your message..."
          onkeydown="if(event.key === 'Enter') sendMessage()"
        />
        <button onclick="sendMessage()" class="button">Send</button>
        <button onclick="downloadChat()" class="download-button">
          Download Chat
        </button>
      </div>

      <!-- Join Chat Screen -->
      <div id="join-chat" style="display: none">
        <a href="#" class="arrow-back" onclick="backToMainMenu()"
          >&larr; Back</a
        >
        <h2>Join Chat</h2>
        <input
          type="text"
          id="chat-code-input"
          class="input-box"
          placeholder="Enter chat code..."
          onkeydown="if(event.key === 'Enter') enterChat()"
        />
        <button onclick="enterChat()" class="button">Enter Chat</button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Firebase Scripts -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        onValue,
        update,
        remove,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBzxpoiDIzCXRX9L2iRuQ9KSPai6stkXNI",
        authDomain: "anon-msgs.firebaseapp.com",
        projectId: "anon-msgs",
        storageBucket: "anon-msgs.appspot.com",
        messagingSenderId: "826610652586",
        appId: "1:826610652586:web:ee9a2b94322936ab6407d3",
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      let userNumber = Math.floor(Math.random() * 1000); // Temporary user number

      // Encryption function using AES
      function encryptMessage(message, key) {
        return CryptoJS.AES.encrypt(message, key).toString();
      }

      // Decryption function using AES
      function decryptMessage(encryptedMessage, key) {
        const bytes = CryptoJS.AES.decrypt(encryptedMessage, key);
        return bytes.toString(CryptoJS.enc.Utf8);
      }

      // Function to create a new chat
      window.createChat = function createChat() {
        document.getElementById("main-menu").style.display = "none";
        document.getElementById("create-chat").style.display = "block";
        const chatCode = generateChatCode();
        document.getElementById(
          "chat-code-display"
        ).innerText = `Chat Code: ${chatCode}`;

        const chatRef = ref(database, "chats/" + chatCode);
        const chatScreen = document.getElementById("chat-screen");
        onValue(chatRef, (snapshot) => {
          const messages = snapshot.val();
          chatScreen.innerHTML = ""; // Clear screen before re-rendering messages
          if (messages) {
            for (const messageKey in messages) {
              const encryptedMessage = messages[messageKey].message;
              if (encryptedMessage) {
                const decryptedMessage = decryptMessage(
                  encryptedMessage,
                  chatCode
                );
                const messageElement = document.createElement("div");
                messageElement.innerText = decryptedMessage;
                messageElement.classList.add("message");
                chatScreen.appendChild(messageElement);
              }
            }
            chatScreen.scrollTop = chatScreen.scrollHeight; // Scroll to bottom
          }
        });

        // Set initial activity time
        update(chatRef, { lastActive: new Date().toISOString() });
      };

      // Function to send a message
      window.sendMessage = function sendMessage() {
        const messageInput = document.getElementById("message-input");
        const message = messageInput.value;
        if (message.trim() !== "") {
          const chatCode = document
            .getElementById("chat-code-display")
            .innerText.split(" ")[2];

          const encryptedMessage = encryptMessage(
            `[${userNumber}] ${message}`,
            chatCode
          );

          const chatRef = ref(database, "chats/" + chatCode);
          push(chatRef, {
            message: encryptedMessage, // Send encrypted message
          });
          messageInput.value = ""; // Clear input

          // Update last activity time
          update(chatRef, { lastActive: new Date().toISOString() });
        }
      };

      // Function to join an existing chat
      window.joinChat = function joinChat() {
        document.getElementById("main-menu").style.display = "none";
        document.getElementById("join-chat").style.display = "block";
      };

      // Function to enter a chat using chat code
      window.enterChat = function enterChat() {
        const chatCodeInput = document.getElementById("chat-code-input");
        const chatCode = chatCodeInput.value.trim();
        if (chatCode !== "") {
          document.getElementById("join-chat").style.display = "none";
          document.getElementById("create-chat").style.display = "block";
          document.getElementById(
            "chat-code-display"
          ).innerText = `Chat Code: ${chatCode}`;

          const chatRef = ref(database, "chats/" + chatCode);
          const chatScreen = document.getElementById("chat-screen");
          onValue(chatRef, (snapshot) => {
            const messages = snapshot.val();
            chatScreen.innerHTML = ""; // Clear screen before re-rendering messages
            if (messages) {
              for (const messageKey in messages) {
                const encryptedMessage = messages[messageKey].message;
                if (encryptedMessage) {
                  const decryptedMessage = decryptMessage(
                    encryptedMessage,
                    chatCode
                  );
                  const messageElement = document.createElement("div");
                  messageElement.innerText = decryptedMessage;
                  messageElement.classList.add("message");
                  chatScreen.appendChild(messageElement);
                }
              }
              chatScreen.scrollTop = chatScreen.scrollHeight; // Scroll to bottom
            }
          });

          // Set initial activity time
          update(chatRef, { lastActive: new Date().toISOString() });
        }
      };

      // Function to go back to main menu
      window.backToMainMenu = function backToMainMenu() {
        document.getElementById("create-chat").style.display = "none";
        document.getElementById("join-chat").style.display = "none";
        document.getElementById("main-menu").style.display = "block";
      };

      // Function to generate a random chat code
      function generateChatCode() {
        return Math.random().toString(36).substr(2, 8);
      }

      // Function to download chat as TXT file
      window.downloadChat = function downloadChat() {
        const chatScreen = document.getElementById("chat-screen");
        const chatCode = document
          .getElementById("chat-code-display")
          .innerText.split(" ")[2];
        const chatContent = chatScreen.innerText;

        const blob = new Blob([chatContent], {
          type: "text/plain;charset=utf-8",
        });
        const downloadLink = document.createElement("a");
        downloadLink.href = URL.createObjectURL(blob);
        downloadLink.download = `chat_${chatCode}.txt`;
        downloadLink.click();
      };
    </script>
    <button
      onclick="window.location.href='https://lamalallama.github.io/tabla.html'"
      class="button"
    >
      Ir a Tabla
    </button>
    <button
      onclick="window.location.href='https://lamalallama.github.io/admin.html'"
      class="button"
    >
      Cosas Admin
    </button>
  </body>
</html>
