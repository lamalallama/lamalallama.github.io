<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App de Mensajería</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div id="app" class="container mx-auto p-4 max-w-md">
    <!-- Pantalla principal -->
    <div id="main-menu" class="space-y-4">
      <h1 class="text-3xl font-bold text-center text-blue-600">App de Mensajería</h1>
      <div class="space-y-2">
        <button onclick="showCreateProfile()" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 transition">Crear Perfil</button>
        <button onclick="createChat()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">Crear Chat</button>
        <button onclick="joinChat()" class="w-full bg-purple-500 text-white py-2 rounded hover:bg-purple-600 transition">Unirse a Chat</button>
        <button id="view-chats" onclick="viewChats()" class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600 transition hidden">Ver Chats</button>
        <button id="profile-button" onclick="showProfile()" class="w-full bg-indigo-500 text-white py-2 rounded hover:bg-indigo-600 transition hidden">Perfil</button>
      </div>
    </div>

    <!-- Pantalla Crear Perfil -->
    <div id="create-profile" class="hidden space-y-4">
      <div class="flex justify-between items-center">
        <button onclick="showMenu()" class="text-blue-500 hover:text-blue-700">← Volver</button>
        <h2 class="text-2xl font-bold text-center">Crear Perfil</h2>
      </div>
      <input type="text" id="username" placeholder="Nombre de usuario" class="w-full p-2 border rounded">
      <input type="password" id="password" placeholder="Contraseña" class="w-full p-2 border rounded">
      <button onclick="saveProfile()" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 transition">Guardar Perfil</button>
    </div>

    <!-- Pantalla Crear Chat -->
    <div id="create-chat" class="hidden space-y-4">
      <div class="flex justify-between items-center">
        <button onclick="showMenu()" class="text-blue-500 hover:text-blue-700">← Volver</button>
        <h2 class="text-2xl font-bold">Chat Creado</h2>
      </div>
      <p id="chat-code-display" class="text-center bg-gray-200 p-2 rounded"></p>
      <p class="text-center">Comparte el código para que otros puedan unirse.</p>
      <button onclick="openChat()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">Ir al Chat</button>
    </div>

    <!-- Pantalla Unirse a Chat -->
    <div id="join-chat" class="hidden space-y-4">
      <div class="flex justify-between items-center">
        <button onclick="showMenu()" class="text-blue-500 hover:text-blue-700">← Volver</button>
        <h2 class="text-2xl font-bold">Unirse a Chat</h2>
      </div>
      <input type="text" id="chat-code-input" placeholder="Ingrese código de chat" class="w-full p-2 border rounded">
      <button onclick="enterChat()" class="w-full bg-purple-500 text-white py-2 rounded hover:bg-purple-600 transition">Unirse</button>
    </div>

    <!-- Pantalla de Chats -->
    <div id="view-chats-screen" class="hidden space-y-4">
      <div class="flex justify-between items-center">
        <button onclick="showMenu()" class="text-blue-500 hover:text-blue-700">← Volver</button>
        <h2 class="text-2xl font-bold">Mis Chats</h2>
      </div>
      <div id="chat-list" class="space-y-2"></div>
    </div>

    <!-- Pantalla de Perfil -->
    <div id="profile-screen" class="hidden space-y-4">
      <div class="flex justify-between items-center">
        <button onclick="showMenu()" class="text-blue-500 hover:text-blue-700">← Volver</button>
        <h2 class="text-2xl font-bold">Perfil</h2>
      </div>
      <p id="profile-info" class="text-center"></p>
      <button onclick="logout()" class="w-full bg-red-500 text-white py-2 rounded hover:bg-red-600 transition">Cerrar Sesión</button>
    </div>

    <!-- Pantalla de Chat -->
    <div id="chat-screen" class="hidden space-y-4">
      <div class="flex justify-between items-center">
        <button onclick="showMenu()" class="text-blue-500 hover:text-blue-700">← Volver</button>
        <h2 class="text-2xl font-bold">Chat</h2>
      </div>
      <p id="chat-code-display-chat" class="text-center bg-gray-200 p-2 rounded"></p>
      <div id="chat-messages" class="space-y-2 h-64 overflow-y-auto bg-white p-4 rounded border"></div>
      <div class="flex space-x-2">
        <input type="text" id="message-input" placeholder="Escribe tu mensaje" class="flex-grow p-2 border rounded">
        <button onclick="sendMessage()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">Enviar</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBzxpoiDIzCXRX9L2iRuQ9KSPai6stkXNI",
      authDomain: "anon-msgs.firebaseapp.com",
      projectId: "anon-msgs",
      storageBucket: "anon-msgs.appspot.com",
      messagingSenderId: "826610652586",
      appId: "1:826610652586:web:ee9a2b94322936ab6407d3"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let currentUser = null;
    let currentChatCode = null;

    // Mostrar el menú principal
    window.showMenu = function() {
      hideAllScreens();
      document.getElementById('main-menu').classList.remove('hidden');
      updateMenuVisibility();
    }

    // Mostrar pantalla de crear perfil
    window.showCreateProfile = function() {
      hideAllScreens();
      document.getElementById('create-profile').classList.remove('hidden');
    }

    // Guardar perfil
    window.saveProfile = function() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      if (username && password) {
        currentUser = { username, password };
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        alert('Perfil guardado');
        updateMenuVisibility();
        showMenu();
      }
    }

    // Mostrar perfil
    window.showProfile = function() {
      hideAllScreens();
      document.getElementById('profile-screen').classList.remove('hidden');
      document.getElementById('profile-info').textContent = `Usuario: ${currentUser.username}`;
    }

    // Cerrar sesión
    window.logout = function() {
      currentUser = null;
      localStorage.removeItem('currentUser');
      updateMenuVisibility();
      showMenu();
    }

    // Crear un nuevo chat
    window.createChat = function() {
      if (!currentUser) {
        alert('Por favor, crea un perfil primero.');
        return;
      }
      const chatRef = ref(database, 'chats');
      const newChatRef = push(chatRef);
      currentChatCode = newChatRef.key;
      set(newChatRef, { creator: currentUser.username });

      document.getElementById('chat-code-display').innerText = `Código del Chat: ${currentChatCode}`;
      hideAllScreens();
      document.getElementById('create-chat').classList.remove('hidden');
    }

    // Unirse a un chat
    window.joinChat = function() {
      if (!currentUser) {
        alert('Por favor, crea un perfil primero.');
        return;
      }
      hideAllScreens();
      document.getElementById('join-chat').classList.remove('hidden');
    }

    window.enterChat = function() {
      const chatCode = document.getElementById('chat-code-input').value;
      if (chatCode) {
        currentChatCode = chatCode;
        document.getElementById('chat-code-display-chat').innerText = `Código del Chat: ${chatCode}`;
        openChat();
      }
    }

    // Ir a la pantalla de chat
    window.openChat = function() {
      hideAllScreens();
      document.getElementById('chat-screen').classList.remove('hidden');
      loadChatMessages();
    }

    // Cargar los mensajes del chat en tiempo real
    function loadChatMessages() {
      const messagesRef = ref(database, `chats/${currentChatCode}/messages`);
      onValue(messagesRef, (snapshot) => {
        const messages = snapshot.val();
        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.innerHTML = ''; // Limpiar mensajes previos
        for (let key in messages) {
          const message = messages[key];
          const messageElement = document.createElement('p');
          messageElement.className = message.sender === currentUser.username ? 'text-right' : 'text-left';
          messageElement.innerHTML = `<span class="bg-gray-200 rounded px-2 py-1 inline-block">${message.sender}: ${message.text}</span>`;
          messagesContainer.appendChild(messageElement);
        }
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
    }

    // Enviar un mensaje
    window.sendMessage = function() {
      const messageInput = document.getElementById('message-input');
      const messageText = messageInput.value;
      if (messageText) {
        const messagesRef = ref(database, `chats/${currentChatCode}/messages`);
        const newMessageRef = push(messagesRef);
        set(newMessageRef, {
          sender: currentUser.username,
          text: messageText
        });
        messageInput.value = ''; // Limpiar el campo de mensaje
      }
    }

    // Ver los chats del usuario
    window.viewChats = function() {
      hideAllScreens();
      document.getElementById('view-chats-screen').classList.remove('hidden');
      const chatListElement = document.getElementById('chat-list');
      chatListElement.innerHTML = ''; // Limpiar la lista de chats

      const chatsRef = ref(database, 'chats');
      onValue(chatsRef, (snapshot) => {
        const chats = snapshot.val();
        for (let chatId in chats) {
          if (chats[chatId].creator === currentUser.username) {
            const chatElement = document.createElement('div');
            chatElement.className = 'bg-white p-2 rounded border';
            chatElement.innerHTML = `
              <p>Chat ID: ${chatId}</p>
              <button onclick="openSpecificChat('${chatId}')" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition">Abrir</button>
              <button onclick="deleteChat('${chatId}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 transition">Eliminar</button>
            `;
            chatListElement.appendChild(chatElement);
          }
        }
      });
    }

    // Abrir un chat específico
    window.openSpecificChat = function(chatId) {
      currentChatCode = chatId;
      document.getElementById('chat-code-display-chat').innerText = `Código del Chat: ${chatId}`;
      openChat();
    }

    // Eliminar un chat
    window.deleteChat = function(chatId) {
      if (confirm('¿Estás seguro de que quieres eliminar este chat?')) {
        const chatRef = ref(database, `chats/${chatId}`);
        remove(chatRef).then(() => {
          alert('Chat eliminado');
          viewChats(); // Actualizar la lista de chats
        }).catch((error) => {
          console.error('Error al eliminar el chat:', error);
        });
      }
    }

    // Ocultar todas las pantallas
    function hideAllScreens() {
      const screens = ['main-menu', 'create-profile', 'create-chat', 'join-chat', 'view-chats-screen', 'profile-screen', 'chat-screen'];
      screens.forEach(screen => document.getElementById(screen).classList.add('hidden'));
    }

    // Actualizar visibilidad de los botones del menú
    function updateMenuVisibility() {
      const viewChatsButton = document.getElementById('view-chats');
      const profileButton = document.getElementById('profile-button');
      if (currentUser) {
        viewChatsButton.classList.remove('hidden');
        profileButton.classList.remove('hidden');
      } else {
        viewChatsButton.classList.add('hidden');
        profileButton.classList.add('hidden');
      }
    }

    // Cargar usuario al iniciar
    window.onload = function() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        updateMenuVisibility();
      }
    }
  </script>
</body>
</html>